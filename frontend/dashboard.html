<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçî Carbon & Cheddar - Sistema Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 1.5em;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-btn {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateX(5px);
        }

        .logout-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .logout-btn:hover {
            background: #c33;
            border-color: #c33;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header h2 {
            color: #333;
        }

        .user-info {
            color: #666;
            font-size: 0.9em;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .card .value {
            font-size: 2.5em;
            color: #667eea;
            font-weight: bold;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #fee;
            color: #c33;
            border: 1px solid #c33;
        }

        .btn-danger:hover {
            background: #c33;
            color: white;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.9em;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
        }

        .close-btn {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
            height: 400px;
        }

        /* Messages */
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #c33;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3c3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .nav-menu {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .nav-item {
                flex: 1;
                min-width: 150px;
            }

            .logout-btn {
                position: relative;
                margin-top: 20px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .stat-card h4 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .stat-card .number {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>üçî Carbon & Cheddar</h1>
            <ul class="nav-menu">
                <li class="nav-item"><button class="nav-btn active" onclick="showSection('ventas')">üí∞ Ventas</button></li>
                <li class="nav-item" id="inventarioNav" style="display: none;"><button class="nav-btn" onclick="showSection('inventario')">üì¶ Inventario</button></li>
                <li class="nav-item" id="mermasNav" style="display: none;"><button class="nav-btn" onclick="showSection('mermas')">‚ö†Ô∏è Mermas</button></li>
                <li class="nav-item"><button class="nav-btn" onclick="showSection('reportes')">üìä Reportes</button></li>
                <li class="nav-item" id="adminNav" style="display: none;"><button class="nav-btn" onclick="showSection('admin')">‚öôÔ∏è Admin</button></li>
            </ul>
            <button class="nav-btn logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 id="sectionTitle">üí∞ Ventas</h2>
                <div class="user-info">Bienvenido, <strong id="username">admin</strong></div>
            </div>

            <!-- VENTAS SECTION -->
            <div id="ventas" class="section active">
                <div class="stats-grid" id="ventasStats"></div>
                
                <div class="cards-grid">
                    <div class="card">
                        <form id="ventasForm">
                            <h3>Nueva Venta</h3>
                            
                            <div class="form-group">
                                <label>N√∫mero de Mesa (Opcional)</label>
                                <input type="text" id="numeroMesa" placeholder="Ej: 5, A1, etc">
                            </div>

                            <div class="form-group">
                                <label>Nombre de Cliente (Opcional)</label>
                                <input type="text" id="nombreCliente" placeholder="Ej: Juan P√©rez">
                            </div>
                            
                            <div class="form-group">
                                <label>Productos</label>
                                <div id="productosVenta"></div>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Procesar Venta</button>
                        </form>
                    </div>
                </div>

                <div class="table-container">
                    <h3>√öltimas Ventas</h3>
                    <table id="ventasTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Total</th>
                                <th>Cliente/Mesa</th>
                                <th>Usuario</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- INVENTARIO SECTION -->
            <div id="inventario" class="section">
                <button class="btn btn-primary" onclick="openModal('nuevoProductoModal')" style="margin-bottom: 20px;">‚ûï Nuevo Producto</button>

                <div class="table-container">
                    <table id="inventarioTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Descripci√≥n</th>
                                <th>Stock</th>
                                <th>Precio</th>
                                <th>Costo</th>
                                <th>Ganancia</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- MERMAS SECTION -->
            <div id="mermas" class="section">
                <button class="btn btn-primary" onclick="openModal('mermModal')" style="margin-bottom: 20px;">‚ö†Ô∏è Registrar Merma</button>

                <div class="table-container">
                    <table id="mermasTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Raz√≥n</th>
                                <th>Usuario</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTES SECTION -->
            <div id="reportes" class="section">
                <div class="stats-grid" id="reportesStats"></div>
                
                <div class="chart-container">
                    <canvas id="ventasHoraChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="ventasDiaChart"></canvas>
                </div>

                <div class="table-container">
                    <h3>Productos M√°s Vendidos</h3>
                    <table id="productosVendidosTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad Vendida</th>
                                <th>Total Ventas</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ADMIN SECTION -->
            <div id="admin" class="section">
                <div class="cards-grid">
                    <div class="card">
                        <h3>Base de Datos</h3>
                        <button class="btn btn-secondary" onclick="exportarDatos()" style="width: 100%; margin-bottom: 10px;">üì• Exportar Datos</button>
                        <button class="btn btn-danger" onclick="limpiarBD()" style="width: 100%;">üóëÔ∏è Limpiar BD (Demo)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Nuevo Producto -->
    <div id="nuevoProductoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('nuevoProductoModal')">&times;</span>
            <div class="modal-header">
                <h3>Nuevo Producto</h3>
            </div>
            <form id="nuevoProductoForm">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="productoNombre" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="productoDescripcion"></textarea>
                </div>
                <div class="form-group">
                    <label>Precio</label>
                    <input type="number" id="productoPrecio" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" id="productoStock" value="0" required>
                </div>
                <div class="form-group">
                    <label>Costo</label>
                    <input type="number" id="productoCosto" step="0.01" value="0" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Crear Producto</button>
            </form>
        </div>
    </div>

    <!-- MODAL: Merma -->
    <div id="mermModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('mermModal')">&times;</span>
            <div class="modal-header">
                <h3>Registrar Merma</h3>
            </div>
            <form id="mermaForm">
                <div class="form-group">
                    <label>Producto</label>
                    <select id="mermaProducto" required></select>
                </div>
                <div class="form-group">
                    <label>Cantidad</label>
                    <input type="number" id="mermaCantidad" min="1" required>
                </div>
                <div class="form-group">
                    <label>Raz√≥n</label>
                    <select id="mermaRazon">
                        <option value="Vencimiento">Vencimiento</option>
                        <option value="Da√±o">Da√±o</option>
                        <option value="P√©rdida">P√©rdida</option>
                        <option value="Prueba">Prueba</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Registrar Merma</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let currentUsername = 'admin';
        let isAdmin = false;
        let allProducts = [];
        let allVentas = [];
        let allMermas = [];
        let ventasHoraChart = null;
        let ventasDiaChart = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            // Leer datos de sesi√≥n
            currentUsername = sessionStorage.getItem('username') || 'admin';
            isAdmin = sessionStorage.getItem('is_admin') === 'true';

            // Si no hay sesi√≥n, redirigir a login
            if (!currentUsername) {
                window.location.href = 'login.html';
                return;
            }

            // Mostrar/ocultar men√∫s seg√∫n permisos
            if (isAdmin) {
                document.getElementById('inventarioNav').style.display = 'block';
                document.getElementById('mermasNav').style.display = 'block';
                document.getElementById('adminNav').style.display = 'block';
            }

            document.getElementById('username').textContent = currentUsername + (isAdmin ? ' üëë' : '');
            loadProducts();
            loadVentas();
            loadMermas();
            loadReports();
        });

        // Mostrar secci√≥n
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            const titles = {
                'ventas': 'üí∞ Ventas',
                'inventario': 'üì¶ Inventario',
                'mermas': '‚ö†Ô∏è Mermas',
                'reportes': 'üìä Reportes',
                'admin': '‚öôÔ∏è Admin'
            };
            document.getElementById('sectionTitle').textContent = titles[sectionId];

            if (sectionId === 'reportes') {
                setTimeout(() => loadReports(), 200);
            } else if (sectionId === 'inventario') {
                loadProducts();
            } else if (sectionId === 'mermas') {
                loadMermas();
            }
        }

        // Cargar productos
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/productos`);
                allProducts = await response.json();

                // Actualizar tabla de inventario
                const tbody = document.querySelector('#inventarioTable tbody');
                tbody.innerHTML = allProducts.map(p => `
                    <tr>
                        <td><strong>${p.nombre}</strong></td>
                        <td>${p.descripcion || '-'}</td>
                        <td><strong>${p.stock}</strong></td>
                        <td>$${p.precio.toLocaleString('es-CO')}</td>
                        <td>$${p.costo.toLocaleString('es-CO')}</td>
                        <td>$${((p.precio - p.costo) * p.stock).toLocaleString('es-CO')}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="editarProducto(${p.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-small btn-danger" onclick="eliminarProducto(${p.id})">üóëÔ∏è Borrar</button>
                        </td>
                    </tr>
                `).join('');

                // Actualizar productos en venta y merma
                renderProductosVenta();
                renderProductosMerma();

            } catch (error) {
                console.error('Error cargando productos:', error);
                document.querySelector('#inventarioTable tbody').innerHTML = `<tr><td colspan="7">Error cargando productos: ${error.message}</td></tr>`;
            }
        }

        // Cargar ventas
        async function loadVentas() {
            try {
                const response = await fetch(`${API_URL}/ventas`);
                allVentas = await response.json();

                const tbody = document.querySelector('#ventasTable tbody');
                
                // Expandir items de cada venta para mostrar como filas individuales
                const rows = [];
                allVentas.forEach(venta => {
                    if (venta.items && venta.items.length > 0) {
                        venta.items.forEach((item, idx) => {
                            rows.push(`
                                <tr>
                                    <td>${item.producto_nombre}</td>
                                    <td>${item.cantidad}</td>
                                    <td>$${item.precio_unitario.toLocaleString('es-CO')}</td>
                                    <td><strong>$${item.subtotal.toLocaleString('es-CO')}</strong></td>
                                    <td>${venta.numero_mesa ? `Mesa: ${venta.numero_mesa}` : ''} ${venta.cliente_nombre ? `Cliente: ${venta.cliente_nombre}` : '-'}</td>
                                    <td>${venta.usuario}</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="abrirVoucher(${venta.id}, 'cliente')">üßæ Cliente</button>
                                        <button class="btn btn-small btn-secondary" onclick="abrirVoucher(${venta.id}, 'cocina')">üë®‚Äçüç≥ Cocina</button>
                                    </td>
                                </tr>
                            `);
                        });
                    } else {
                        // Si no hay items, mostrar la venta como fila (fallback)
                        rows.push(`
                            <tr>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td><strong>$${venta.total.toLocaleString('es-CO')}</strong></td>
                                <td>${venta.numero_mesa ? `Mesa: ${venta.numero_mesa}` : ''} ${venta.cliente_nombre ? `Cliente: ${venta.cliente_nombre}` : '-'}</td>
                                <td>${venta.usuario}</td>
                                <td>
                                    <button class="btn btn-small btn-secondary" onclick="abrirVoucher(${venta.id}, 'cliente')">üßæ Cliente</button>
                                    <button class="btn btn-small btn-secondary" onclick="abrirVoucher(${venta.id}, 'cocina')">üë®‚Äçüç≥ Cocina</button>
                                </td>
                            </tr>
                        `);
                    }
                });
                
                tbody.innerHTML = rows.slice(0, 20).join('');

                // Actualizar stats
                const totalHoy = allVentas
                    .filter(v => new Date(v.created_at).toDateString() === new Date().toDateString())
                    .reduce((sum, v) => sum + v.total, 0);

                const cantidadHoy = allVentas
                    .filter(v => new Date(v.created_at).toDateString() === new Date().toDateString())
                    .length;

                document.getElementById('ventasStats').innerHTML = `
                    <div class="stat-card">
                        <h4>Ventas Hoy</h4>
                        <div class="number">${cantidadHoy}</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Hoy</h4>
                        <div class="number">$${totalHoy.toLocaleString('es-CO')}</div>
                    </div>
                `;

            } catch (error) {
                console.error('Error cargando ventas:', error);
            }
        }

        // Cargar mermas
        async function loadMermas() {
            try {
                const response = await fetch(`${API_URL}/mermas`);
                allMermas = await response.json();

                const tbody = document.querySelector('#mermasTable tbody');
                tbody.innerHTML = allMermas.slice(0, 20).map(m => `
                    <tr>
                        <td>${m.producto_nombre}</td>
                        <td><strong>${m.cantidad}</strong></td>
                        <td>${m.razon}</td>
                        <td>${m.usuario}</td>
                        <td>${new Date(m.created_at).toLocaleString('es-CO')}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error cargando mermas:', error);
            }
        }

        // Renderizar productos en venta
        function renderProductosVenta() {
            const container = document.getElementById('productosVenta');
            container.innerHTML = allProducts.map(p => `
                <div style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                    <label style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" class="producto-check" value="${p.id}" data-nombre="${p.nombre}" data-precio="${p.precio}">
                        <span style="margin-left: 8px;">${p.nombre} - Stock: ${p.stock} - $${p.precio}</span>
                    </label>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                        <input type="number" class="producto-cantidad" value="1" min="1" style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Cant.">
                    </div>
                    <input type="text" class="producto-observaciones" placeholder="Observaciones (Ej: sin cebolla, con extra mayo)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                </div>
            `).join('');
        }

        // Renderizar productos en merma
        function renderProductosMerma() {
            const select = document.getElementById('mermaProducto');
            select.innerHTML = `<option value="">Selecciona un producto</option>` + allProducts.map(p => `
                <option value="${p.id}" data-stock="${p.stock}">
                    ${p.nombre} (Stock: ${p.stock})
                </option>
            `).join('');
        }

        // Procesar venta
        document.getElementById('ventasForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const items = [];
            document.querySelectorAll('.producto-check:checked').forEach(checkbox => {
                const cantidad = parseInt(checkbox.parentElement.parentElement.querySelector('.producto-cantidad').value);
                const observaciones = checkbox.parentElement.parentElement.querySelector('.producto-observaciones').value;
                
                if (cantidad > 0) {
                    items.push({
                        id: parseInt(checkbox.value),
                        nombre: checkbox.getAttribute('data-nombre'),
                        precio: parseFloat(checkbox.getAttribute('data-precio')),
                        cantidad: cantidad,
                        observaciones: observaciones
                    });
                }
            });

            if (items.length === 0) {
                alert('Selecciona al menos un producto');
                return;
            }

            const numeroMesa = document.getElementById('numeroMesa').value;
            const nombreCliente = document.getElementById('nombreCliente').value;

            try {
                const response = await fetch(`${API_URL}/ventas`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Is-Admin': isAdmin.toString()
                    },
                    body: JSON.stringify({
                        items: items,
                        usuario: currentUsername,
                        numero_mesa: numeroMesa,
                        cliente_nombre: nombreCliente
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ Venta registrada - Total: $' + data.venta.total);
                    
                    // Imprimir autom√°ticamente copia cocina y cliente
                    if (data.venta && data.venta.id) {
                        const ventaId = data.venta.id;
                        setTimeout(() => {
                            abrirVoucher(ventaId, 'cocina');
                        }, 500);
                        setTimeout(() => {
                            abrirVoucher(ventaId, 'cliente');
                        }, 2000);
                    }
                    
                    document.getElementById('ventasForm').reset();
                    document.querySelectorAll('.producto-check').forEach(c => c.checked = false);
                    loadProducts();
                    loadVentas();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Crear producto
        document.getElementById('nuevoProductoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const producto = {
                nombre: document.getElementById('productoNombre').value,
                descripcion: document.getElementById('productoDescripcion').value,
                precio: parseFloat(document.getElementById('productoPrecio').value),
                stock: parseInt(document.getElementById('productoStock').value),
                costo: parseFloat(document.getElementById('productoCosto').value)
            };

            try {
                const response = await fetch(`${API_URL}/productos`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Is-Admin': isAdmin.toString()
                    },
                    body: JSON.stringify(producto)
                });

                if (response.ok) {
                    alert('‚úÖ Producto creado');
                    closeModal('nuevoProductoModal');
                    document.getElementById('nuevoProductoForm').reset();
                    loadProducts();
                } else {
                    const error = await response.json();
                    alert('‚ùå Error: ' + (error.error || 'Error al crear producto'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Registrar merma
        document.getElementById('mermaForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const merma = {
                producto_id: parseInt(document.getElementById('mermaProducto').value),
                cantidad: parseInt(document.getElementById('mermaCantidad').value),
                razon: document.getElementById('mermaRazon').value,
                usuario: currentUsername
            };

            try {
                const response = await fetch(`${API_URL}/mermas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(merma)
                });

                if (response.ok) {
                    alert('‚úÖ Merma registrada');
                    closeModal('mermModal');
                    document.getElementById('mermaForm').reset();
                    loadProducts();
                    loadMermas();
                } else {
                    alert('‚ùå Error: ' + (await response.json()).error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Cargar reportes
        async function loadReports() {
            try {
                console.log('Cargando reportes...');
                
                // Resumen
                const resumenResp = await fetch(`${API_URL}/reportes/resumen`);
                if (!resumenResp.ok) throw new Error(`Resumen: ${resumenResp.status}`);
                const resumen = await resumenResp.json();
                console.log('Resumen:', resumen);

                document.getElementById('reportesStats').innerHTML = `
                    <div class="stat-card">
                        <h4>Ventas Hoy</h4>
                        <div class="number">${resumen.hoy.cantidad_ventas}</div>
                        <p>Total: $${resumen.hoy.total.toLocaleString('es-CO')}</p>
                    </div>
                    <div class="stat-card">
                        <h4>√öltimos 7 D√≠as</h4>
                        <div class="number">${resumen.ultimos_7_dias.cantidad_ventas}</div>
                        <p>Total: $${resumen.ultimos_7_dias.total.toLocaleString('es-CO')}</p>
                    </div>
                    <div class="stat-card">
                        <h4>Stock Total</h4>
                        <div class="number">${resumen.inventario.stock_total}</div>
                        <p>Valor: $${resumen.inventario.valor_stock.toLocaleString('es-CO')}</p>
                    </div>
                `;

                // Ventas por hora
                const ventasHoraResp = await fetch(`${API_URL}/reportes/ventas-por-hora`);
                if (!ventasHoraResp.ok) throw new Error(`Ventas por hora: ${ventasHoraResp.status}`);
                const ventasHora = await ventasHoraResp.json();
                console.log('Ventas por hora:', ventasHora);
                actualizarGraficoHora(ventasHora);

                // Ventas diarias
                const ventasDiaResp = await fetch(`${API_URL}/reportes/ventas-diarias?dias=7`);
                if (!ventasDiaResp.ok) throw new Error(`Ventas diarias: ${ventasDiaResp.status}`);
                const ventasDia = await ventasDiaResp.json();
                console.log('Ventas diarias:', ventasDia);
                actualizarGraficoDia(ventasDia);

                // Productos m√°s vendidos
                const productosResp = await fetch(`${API_URL}/reportes/productos-mas-vendidos?limite=5`);
                if (!productosResp.ok) throw new Error(`Productos: ${productosResp.status}`);
                const productos = await productosResp.json();
                console.log('Productos m√°s vendidos:', productos);

                const tbody = document.querySelector('#productosVendidosTable tbody');
                tbody.innerHTML = productos.length > 0 
                    ? productos.map(p => `
                        <tr>
                            <td>${p.producto_nombre}</td>
                            <td><strong>${p.cantidad_vendida}</strong></td>
                            <td>$${p.total_ventas.toLocaleString('es-CO')}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="3">Sin datos de ventas</td></tr>';

            } catch (error) {
                console.error('Error cargando reportes:', error);
                document.getElementById('reportesStats').innerHTML = `<div style="color: red; padding: 10px;">Error: ${error.message}</div>`;
            }
        }

        // Gr√°ficos
        function actualizarGraficoHora(datos) {
            try {
                const ctx = document.getElementById('ventasHoraChart');
                if (!ctx) return;
                if (ventasHoraChart) ventasHoraChart.destroy();

                if (!datos || datos.length === 0) {
                    ctx.parentElement.innerHTML = '<p style="text-align: center; color: #999;">Sin datos de ventas por hora</p>';
                    return;
                }

                ventasHoraChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: datos.map(d => d.hora),
                        datasets: [{
                            label: 'Ventas por Hora',
                            data: datos.map(d => d.total),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            } catch (error) {
                console.error('Error en gr√°fico de hora:', error);
            }
        }

        function actualizarGraficoDia(datos) {
            try {
                const ctx = document.getElementById('ventasDiaChart');
                if (!ctx) return;
                if (ventasDiaChart) ventasDiaChart.destroy();

                if (!datos || datos.length === 0) {
                    ctx.parentElement.innerHTML = '<p style="text-align: center; color: #999;">Sin datos de ventas diarias</p>';
                    return;
                }

                ventasDiaChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: datos.map(d => d.fecha),
                        datasets: [{
                            label: 'Ventas Diarias',
                            data: datos.map(d => d.total),
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118,75,162,0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            } catch (error) {
                console.error('Error en gr√°fico de d√≠a:', error);
            }
        }

        // Modales
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Logout
        function logout() {
            if (confirm('¬øDeseas cerrar sesi√≥n?')) {
                // Limpiar sessionStorage
                sessionStorage.clear();
                // Redirigir a login
                window.location.href = 'login.html';
            }
        }

        // Abrir voucher
        function abrirVoucher(ventaId, tipo) {
            const url = `${API_URL.replace('/api', '')}/voucher/${ventaId}?tipo=${tipo}`;
            window.open(url, '_blank');
        }

        // Otros
        function editarProducto(id) {
            alert('Funci√≥n de edici√≥n pr√≥ximamente');
        }

        function eliminarProducto(id) {
            if (confirm('¬øEliminar producto?')) {
                fetch(`${API_URL}/productos/${id}`, { 
                    method: 'DELETE',
                    headers: { 'X-Is-Admin': isAdmin.toString() }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            alert('‚ùå ' + data.error);
                        } else {
                            loadProducts();
                        }
                    })
                    .catch(err => alert('Error: ' + err.message));
            }
        }

        function exportarDatos() {
            alert('Funci√≥n de exportaci√≥n pr√≥ximamente');
        }

        function limpiarBD() {
            alert('Funci√≥n deshabilitada por seguridad');
        }
    </script>
</body>
</html>
